<!DOCTYPE html>
<html lang="fi">
<head>
	<title>Skippo</title>
	<meta charset="utf-8">
	<!--<link rel="manifest" href="manifest.json">-->
	<!--<link rel="icon" type="image/x-icon" href="favicon.png">-->

	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">

	<meta property="og:title" content="Sanapeli">
	<meta property="og:description" content="Skippo pasianssi">
	
	
	<link type="text/css" href="jquery/jquery-ui.css" rel="Stylesheet" />
	<script type="text/javascript" src="jquery/jquery.min.js"></script>
	<script type="text/javascript" src="jquery/jquery-ui.min.js"></script>
	
	<script src="riffwave.js"></script>
	<script src="sfxr.js"></script>
	<script src="sounds.js"></script>
	<script src="helpers.js"></script>
	
	<link type="text/css" href="style.css?v=5" rel="Stylesheet" />
	<link type="text/css" href="cards_inline.css?v=3" rel="Stylesheet" />
</head>
<body>


<div id="game" class="noselect">
	<div id="enemy_cards" class="cardbox"></div>
	<div id="enemy_slot" class="cardbox"></div>
	<div id="play_slot" class="cardbox"></div>
	<div id="my_slot" class="cardbox"></div>
	<div id="my_cards" class="cardbox"></div>
</div>

<xmp id="output" style="font-size:9px; display:none"></xmp>


<script>
let DECK = [];
let DISCARD_DECK = [];
let game_started = false;
let selected_card = [];
let ENEMY_CARDS = [];
let MY_CARDS = [];


function new_deck(total_jokers, kings_as_jokers){
	if(typeof kings_as_jokers === "undefined"){
		kings_as_jokers = false;
	}
	if(typeof total_jokers === "undefined"){
		total_jokers = 3;
	}
	let deck = [];
	for(let s = 1; s <= 4; s++){
		for(let i = 1; i <= 13; i++){
			if(i == 13 && kings_as_jokers){
				deck.push("joker");
			}else{
				deck.push("c"+s+"_"+i);
			}
		}
	}
	for(let i = 0; i < total_jokers; i++){
		deck.push("joker");
	}
	return deck;
}


function create_playing_deck(){
	// 3 decks for skipbo:
	let d1 = new_deck(3, true);
	let d2 = new_deck(3, true);
	let d3 = new_deck(3, true);
	
	return d1.concat(d2).concat(d3);
}


// shuffle discard pile and add to game deck:
function refill_deck(){
	if(DISCARD_DECK.length > 0){
		shuffleArray(DISCARD_DECK);
		// last item is first item, so reverse deck so we can add them in the end of the deck:
		DECK.reverse();
		DECK = DECK.concat(DISCARD_DECK);
		// reverse back to original order with added cards at the start of array:
		DECK.reverse();
		DISCARD_DECK = [];
	}
}

function get_card_from_deck(){
	let card = -1;
	if(DECK.length == 0){
		refill_deck();
	}
	if(DECK.length > 0){
		card = DECK.pop();
	}
	return card;
}



function cards_to_discard_deck(cards){
	DISCARD_DECK.concat(cards);
}


function set_deck_cards(deck_id, cards){
	let amount = 5;
	let hasdeck = false;
	let deck_card_visible = false;
	
	if(deck_id == "enemy_cards"){
		amount = 5;
		hasdeck = false;
		deck_card_visible = true;
	}else if(deck_id == "enemy_slot"){
		amount = 4;
		hasdeck = true;
		deck_card_visible = true;
	}else if(deck_id == "play_slot"){
		amount = 4;
		hasdeck = true;
		deck_card_visible = false;
	}else if(deck_id == "my_slot"){
		amount = 4;
		hasdeck = true;
		deck_card_visible = true;
	}else if(deck_id == "my_cards"){
		amount = 5;
		hasdeck = false;
	}
	
	
	$("#"+deck_id).empty();
	let i;
	for(i = 0; i < cards.length; i++){
		let card_id = cards[i];
		let is_deck_class = "";
		let deck_visible_class = "";
		if(card_id.length == 0){
			card_id = "empty";
		}
		if(card_id == "playerdeck"){
			card_id = "backside";
			deck_visible_class = " deck_visible";
		}
		if(card_id == "gamedeck"){
			card_id = "backside";
		}
		if(card_id == "backside"){
			is_deck_class = " is_deck";
		}
		$("#"+deck_id).append($("<div class='card "+card_id+is_deck_class+deck_visible_class+"' data-deck='"+deck_id+"' data-index='"+i+"' id='"+deck_id+"_"+i+"'></div>"));
	}
}

function fill_deck(deck_id, cards){
	set_deck_cards(deck_id, cards);
}









function new_game(){
	DECK = create_playing_deck();
	shuffleArray(DECK);
	play_sound("shuffle");
	
	selected_card = [];
	game_started = true;
	
	DISCARD_DECK = [];
	
	ENEMY_CARDS = [];
	MY_CARDS = [];
	
	console.log(DECK);
	console.log(DECK);
	
	for(let i = 0; i < 5; i++){
		let card1 = get_card_from_deck();
		ENEMY_CARDS.push(card1);
		let card2 = get_card_from_deck();
		MY_CARDS.push(card2);
	}
	
	fill_deck("enemy_cards", ENEMY_CARDS);
	fill_deck("enemy_slot", ["", "", "", "", "playerdeck"]);
	fill_deck("play_slot", ["", "", "", "", "gamedeck"]);
	fill_deck("my_slot", ["", "", "", "", "playerdeck"]);
	fill_deck("my_cards", MY_CARDS);
}



function clear_game(){
	DECK = [];
	DISCARD_DECK = [];
	game_started = false;
	selected_card = [];
	
	ENEMY_CARDS = ["", "", "", "", ""];
	MY_CARDS    = ["", "", "", "", ""];
	
	fill_deck("enemy_cards", ENEMY_CARDS);
	fill_deck("enemy_slot", ["", "", "", "", "playerdeck"]);
	fill_deck("play_slot", ["", "", "", "", "gamedeck"]);
	fill_deck("my_slot", ["", "", "", "", "playerdeck"]);
	fill_deck("my_cards", MY_CARDS);
}





var encoder = new TextEncoder("ascii");
var decoder = new TextDecoder("ascii");
var base64Table = encoder.encode('ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=');

function toBase64(dataArr){
    var padding = dataArr.byteLength % 3;
    var len = dataArr.byteLength - padding;
    padding = padding > 0 ? (3 - padding) : 0;
    var outputLen = ((len/3) * 4) + (padding > 0 ? 4 : 0);
    var output = new Uint8Array(outputLen);
    var outputCtr = 0;
    for(var i=0; i<len; i+=3){              
        var buffer = ((dataArr[i] & 0xFF) << 16) | ((dataArr[i+1] & 0xFF) << 8) | (dataArr[i+2] & 0xFF);
        output[outputCtr++] = base64Table[buffer >> 18];
        output[outputCtr++] = base64Table[(buffer >> 12) & 0x3F];
        output[outputCtr++] = base64Table[(buffer >> 6) & 0x3F];
        output[outputCtr++] = base64Table[buffer & 0x3F];
    }
    if (padding == 1) {
        var buffer = ((dataArr[len] & 0xFF) << 8) | (dataArr[len+1] & 0xFF);
        output[outputCtr++] = base64Table[buffer >> 10];
        output[outputCtr++] = base64Table[(buffer >> 4) & 0x3F];
        output[outputCtr++] = base64Table[(buffer << 2) & 0x3F];
        output[outputCtr++] = base64Table[64];
    } else if (padding == 2) {
        var buffer = dataArr[len] & 0xFF;
        output[outputCtr++] = base64Table[buffer >> 2];
        output[outputCtr++] = base64Table[(buffer << 4) & 0x3F];
        output[outputCtr++] = base64Table[64];
        output[outputCtr++] = base64Table[64];
    }
    
    var ret = decoder.decode(output);
    output = null;
    dataArr = null;
    return ret;
}


var output = "";

function generate_images(){

	output = "";
	
	let imgs = [];	
	imgs.push(["backside", "back"]);
	imgs.push(["joker", "joker"]);
	for(let s = 1; s <= 4; s++){
		for(let i = 1; i <= 13; i++){
			let card_id = s+"_"+i;
			imgs.push(["c"+card_id, card_id]);
		}
	}

	var request = new XMLHttpRequest();
	(function loop(i, length) {
		if (i>= length) {
			return;
		}
		var file_name = imgs[i][1];
		var css_name = imgs[i][0];
		var url = "cards/"+file_name+".png";

		request.open("GET", url, true);
		request.responseType = "arraybuffer";
		request.onreadystatechange = function() {
			if(request.readyState === XMLHttpRequest.DONE && request.status === 200) {
				var arrayBuffer = request.response;
				var byteArray = new Uint8Array(arrayBuffer);
				let b64 = toBase64(byteArray);

				output += "."+css_name+" { background-image:url('data:image/png;base64,"+b64+"'); }\r\n";

				// update only at end:
				if(i == imgs.length-1){
					$("#output").text(output);
				}
				
				loop(i + 1, length);
			}
		}
		request.send();
	})(0, imgs.length);
}






$(document).on("click", ".card", function(e){
	
	if($(this).hasClass("is_deck")){
		console.log("is_deck");
		new_game();
	}else{
		console.log("card");
		if(selected_card.length > 0){
			$("#"+selected_card[2]).removeClass("selected");
		}
		
		let deck_id = $(this).data("deck");
		let card_index = $(this).data("index");
		let unique_id = deck_id+"_"+card_index;
		selected_card = [deck_id, card_index, unique_id];
		$(this).addClass("selected");
		play_sound("click");
	}
	console.log($(this).attr("id"));
});







function update_ui(){

	
}






$(document).ready(function(){
	console.log("ready");

	generate_images(); // creates base64 encoded image data classes.

	generate_sounds();
	
	clear_game();

});

</script>






</body>
</html>